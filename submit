#!/usr/bin/env bash

set -e

script_path="$( dirname "$0" )"

# Import our functions.

source "$script_path"/submit-compat.fun
source "$script_path"/submit-menus.fun
source "$script_path"/submit-xml.fun
source "$script_path"/submit-utils.fun

timestamp="$( date -u +"%Y%m%d %T" )"

# TODO: Add command line parsing here.

data_dir="$1"
if [[ ! -d "$data_dir" ]]; then
    printf "No such directory: %s\n" "$data_dir" >&2
    exit 1
fi

# This is where we store the retrieved ENA IDs etc.

state_xml="$data_dir/state.xml"

# Get data from configuration file.  We currently assume that the
# configuration file, config.xml, is available in the current directory.
# We may change this later so that it's picked up from $data_dir
# instead.

username="$( get_value "/config/username" <config.xml )"
password="$( get_value "/config/password" <config.xml )"
center_name="$( get_value "/config/center_name" <config.xml )"

# Examine the XML files in $data_dir to figure out what they are.
# Creates the associative array xml_files with file names as keys and
# the top-level XML element as values.

declare -A xml_files

for f in "$data_dir"/*.xml; do
    if [[ "$f" == "$state_xml" ]]; then
        continue
    fi

    f_basename="$( basename "$f" )"
    f_type="$( xmlstarlet el "$f" | head -n 1 )"

    xml_files["$f_basename"]="$f_type"
done

main_menu
